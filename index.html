<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        #chat-container {
            height: 80vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        .message-timestamp {
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">Chat Room</h1>
        <div id="chat-container" class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
            <div id="messages" class="flex flex-col space-y-2"></div>
        </div>
        <div class="flex space-x-2">
            <input
                id="message-input"
                type="text"
                placeholder="Type a message..."
                class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button
                id="send-button"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                Send
            </button>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:3000', {
            transports: ['websocket'],
            reconnection: true,
            connectionStateRecovery: {}
        });

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatContainer = document.getElementById('chat-container');

        // Generate a simple user ID for demo purposes
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);

        // Handle receiving messages
        socket.on('chat message', (msg, messageId) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add(
                'message-bubble',
                'p-3',
                'rounded-lg',
                'mb-2',
                socket.id === messageId ? 'bg-blue-100 ml-auto' : 'bg-gray-200 mr-auto'
            );
            const contentElement = document.createElement('p');
            contentElement.textContent = msg;
            const timestampElement = document.createElement('p');
            timestampElement.classList.add('message-timestamp');
            timestampElement.textContent = new Date().toLocaleTimeString();
            messageElement.appendChild(contentElement);
            messageElement.appendChild(timestampElement);
            messagesContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Handle sending messages
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                const clientOffset = `${socket.id}-${Date.now()}`;
                socket.emit('chat message', message, clientOffset, () => {
                    messageInput.value = '';
                });
            }
        }

        // Send message on button click
        sendButton.addEventListener('click', sendMessage);

        // Send message on Enter key press
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            const errorElement = document.createElement('div');
            errorElement.classList.add('text-red-500', 'text-center', 'p-2');
            errorElement.textContent = 'Failed to connect to server. Retrying...';
            messagesContainer.appendChild(errorElement);
        });

        // Handle successful reconnection
        socket.on('connect', () => {
            messagesContainer.querySelectorAll('.text-red-500').forEach(el => el.remove());
        });
    </script>
</body>
</html>